import{r as f,j as e,M as k,a as q,u as G,P as L,c as I,f as z,Q as d}from"./index-59f852e0.js";import"./styles.module-60436982.js";import{u as K,a as M,b as V,c as X,d as Y,e as Z,f as ee,C as te}from"./appointmentTableApi-96b44271.js";import{e as S}from"./utils-045dd2ef.js";import"./styles.module-eea2a584.js";import{H as se}from"./HeaderTemplate-e8e3042a.js";import{S as F}from"./arrow-bottom-filter-60385137.js";import{B as oe}from"./BackButton-49770558.js";import{D as H}from"./CardsNavigate-1d0bb8c7.js";import{T as ae}from"./TechInfo-e92d6d5d.js";import"./Checkbox-a614abe7.js";import"./Typography-2b2ac974.js";import"./extendSxProp-b10dd2ec.js";import"./Modal-9b3da93c.js";import"./DatePicker-431f7e7c.js";/* empty css               */import"./Popper-a4dacda7.js";import"./lodash-70c94f30.js";import"./useMutation-103a06a7.js";import"./useBaseQuery-c5bc7cdc.js";import"./useQuery-c59b793a.js";import"./services-ico-36251f58.js";import"./styles.module-4a1edd24.js";import"./styles.module-6aece55b.js";function A({copyId:u,handlePaste:g}){const[n,x]=f.useState(!1),h=async a=>{try{const b=await navigator.clipboard.readText(),c=JSON.parse(b);return{isCopy:!!c[a],id:c[a],params:c}}catch{return{isCopy:!1,id:"",params:{}}}},w=async(a,b)=>{try{const{isCopy:c,id:B,params:T}=await h(a);c&&b({id:B,params:T})}catch(c){console.error("Ошибка чтения буфера обмена:",c)}};return f.useEffect(()=>{(async()=>{const{isCopy:a}=await h(u);x(!a)})()},[u]),e.jsx(k,{disabled:n,onClick:()=>w(u,g),children:"Вставить"})}const ne="_wrapper_188hu_1",ce="_draggable_188hu_7",re="_reception_188hu_21",le="_headBlock_188hu_26",ie="_blockWithPadding_188hu_27",me="_arrowBottom_188hu_36",de="_active_188hu_43",pe="_lineBlock_188hu_47",ue="_itemBlock_188hu_51",he="_toggle_188hu_56",be="_backButton_188hu_75",o={wrapper:ne,draggable:ce,reception:re,headBlock:le,blockWithPadding:ie,arrowBottom:me,active:de,lineBlock:pe,itemBlock:ue,toggle:he,backButton:be};function ke(u){const g=G(),{mutate:n}=Y(),{mutate:x}=Z(),[h,w]=f.useState(!1),{template:a,subTemplates:b,refetchData:c,onCreateReception:B,onDeleteSubTemplate:T}=u,{handleTemplates:P}=ee(),C=t=>{const s=a.bodyBlocks.find(({id:r})=>r===t);if(!s)return;const i={...s,lineBlocks:s.lineBlocks.map(({blocks:r,...j})=>({...j,blockInfo:r}))};P([i]),g(L.template.create(a.id.toString()))},D=async t=>{try{await navigator.clipboard.writeText(t),d("Copied!",{type:"info"})}catch(s){console.error("Ошибка копирования в буфер обмена:",s)}},E=async({id:t})=>{const s=b.find(r=>r.id===Number(t));if(!s)return;const i=s.bodyBlocks.map(r=>{const j={name:r.name,positionId:r.positionId,lineBlocks:r.lineBlocks.map(({id:y,blocks:_,...v})=>({...v,blockInfo:_.map(({id:W,status:R,...m})=>({...m,status:R,value:m.value??null}))})),subTemplateId:a.id};return new Promise((y,_)=>{n(j,{onSuccess:async()=>{y()},onError:v=>{d(S(v),{type:"error"}),_(v)}})})});try{await Promise.all(i),d("Copied!",{type:"success"}),c()}catch(r){console.error("Ошибка при выполнении мутаций:",r)}},l=(t,{id:s,params:i})=>{const r=b.find(m=>m.id===i.id);if(!r)throw new Error("subTemplate of undefined");const j=r.bodyBlocks.find(m=>m.id===Number(s));if(!j)throw new Error("bodyBlock of undefined");const y=a.bodyBlocks.find(m=>m.id===t);if(!y)throw new Error("targetTemplate of undefined");const _=m=>m.map(({id:fe,blocks:J,...Q})=>({...Q,blockInfo:J.map(({id:ge,status:U,...$})=>({...$,status:U,value:$.value??null}))})),v=_(y.lineBlocks),W=_(j.lineBlocks),R={id:t,name:y.name,positionId:j.positionId,lineBlocks:[...v,...W],subTemplateId:a.id};n(R,{onSuccess:async()=>{d("Copied!",{type:"success"}),c()},onError:m=>{d(S(m),{type:"error"})}})},p=async t=>{x(t,{onSuccess:async()=>{d("Deleted!",{type:"success"}),c()},onError:s=>{d(S(s),{type:"error"})}})},N=t=>e.jsxs(e.Fragment,{children:[e.jsx(k,{onClick:()=>{B(),t()},children:"Создать прием"}),e.jsx(A,{copyId:"templateId",handlePaste:s=>{E(s),t()}}),e.jsx(k,{onClick:()=>{D(`{"templateId":${a.id}}`),t()},children:"Копировать"}),e.jsx(k,{onClick:()=>T(a.id),children:"Удалить прием"})]}),O=(t,s)=>e.jsxs(e.Fragment,{children:[e.jsx(k,{onClick:()=>{g(L.template.create(a.id.toString())),t()},children:"Создать блок"}),e.jsx(k,{onClick:()=>{D(`{"subTemplateId":${s}, "id":${a.id}}`),t()},children:"Копировать"}),e.jsx(A,{copyId:"subTemplateId",handlePaste:i=>{l(s,i),t()}}),e.jsx(k,{onClick:()=>{C(s),t()},children:"Редактировать"}),e.jsx(k,{onClick:()=>s&&p(s),children:"Удалить"})]});return e.jsxs(e.Fragment,{children:[e.jsx(H,{menuItems:N,children:e.jsxs("button",{type:"button",className:I(o.draggable,o.reception),onClick:()=>w(t=>!t),children:[e.jsx("div",{className:o.headBlock,children:a.name}),e.jsx("div",{className:I(o.arrowBottom,{[o.active]:h}),children:e.jsx(F,{})})]})}),h&&e.jsxs("div",{children:[a.bodyBlocks.map(t=>e.jsxs("div",{className:I(o.draggable),children:[e.jsx("div",{className:o.headBlock,children:t.name}),e.jsx("div",{className:I(o.blockWithPadding,o.lineBlock),children:t.lineBlocks.map(s=>e.jsx("div",{className:o.itemBlock,children:s.blocks.map(i=>e.jsx("div",{children:f.createElement(te,{...i,key:i.lineId,type:"preview",subTemplateId:t.subTemplateId,bodyBlockId:s.id,status:i.status})},i.id))},s.id))}),e.jsx(H,{menuItems:s=>O(s,t.id),children:e.jsx("div",{className:o.arrowBottom,children:e.jsx(F,{})})})]},t.id)),a.bodyBlocks.length?null:e.jsx("div",{className:o.draggable,children:e.jsx(H,{menuItems:O,children:e.jsx("div",{className:o.arrowBottom,children:e.jsx(F,{})})})})]})]})}function Je(){const u=q(),g=G(),{data:n,isLoading:x,refetch:h}=K(u.subTemplateId),{mutate:w}=M(),{mutate:a}=V(),{mutate:b}=X(),[c,B]=f.useState(!1),[T,P]=f.useState([]),C=l=>{const p={name:`Прием №${l}`,templateId:Number(u.subTemplateId)};w(p,{onSuccess:()=>{h()},onError:N=>{d(S(N),{type:"error"})}})},D=l=>{b(l,{onSuccess:()=>{d("Success!",{type:"success"}),g(-1)},onError:p=>{d(S(p),{type:"error"})}})},E=l=>{a(l,{onSuccess:()=>{h(),d("Success!",{type:"success"})},onError:p=>{d(S(p),{type:"error"})}})};return f.useEffect(()=>{!x&&!(n!=null&&n.subTemplates.length)&&C(1)},[x,n]),f.useEffect(()=>{const l=(n==null?void 0:n.subTemplates.sort((p,N)=>p.id-N.id))??[];P(l)},[n]),x?null:n!=null&&n.subTemplates?e.jsxs(e.Fragment,{children:[e.jsx(se,{}),e.jsxs("div",{className:o.wrapper,children:[e.jsx(oe,{title:"",link:L.template.root,className:o.backButton}),e.jsx("div",{className:o.draggable,children:e.jsxs("div",{className:o.headBlock,children:[n.category,". ",n.name]})}),e.jsx(ae,{techInfo:{info:n.techInfo}}),T.map(l=>e.jsxs("div",{children:[e.jsx(ke,{template:l,subTemplates:T,refetchData:()=>h(),onCreateReception:()=>C(n.subTemplates.length+1),onDeleteSubTemplate:p=>E(p)}),e.jsx("div",{className:I(o.draggable,o.reception),children:e.jsx("div",{className:o.headBlock,children:"Краткое резюме посещения"})})]},l.id)),e.jsxs("div",{className:o.toggleBlock,children:[e.jsx(z,{open:c,onClose:()=>B(!1),style:{top:-50,left:30},children:e.jsx(k,{onClick:()=>D(Number(u.subTemplateId)),children:"Удалить"})}),e.jsx("button",{type:"button",onClick:()=>B(!0),className:I(o.toggle,{[o.active]:c}),children:"+"})]})]})]}):(g(-1),null)}export{Je as default};

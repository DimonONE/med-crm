import{r as x,j as e,M as u,a as U,u as A,P as L,c as w,f as q,Q as h}from"./index-28b8728f.js";import"./styles.module-60436982.js";import{u as z,a as K,b as M,c as V,d as X,e as Y,C as Z}from"./appointmentTableApi-e27f7e8c.js";import{e as S}from"./utils-045dd2ef.js";import"./styles.module-eea2a584.js";import{H as ee}from"./HeaderTemplate-eb987451.js";import{S as F}from"./arrow-bottom-filter-ed2c8b82.js";import{B as te}from"./BackButton-03403362.js";import{D as H}from"./CardsNavigate-bcbe1f7e.js";import{T as se}from"./TechInfo-3aec2ce0.js";import"./Checkbox-aa482c20.js";import"./Typography-37f7fd1d.js";import"./extendSxProp-3260528d.js";import"./Modal-25888893.js";import"./DatePicker-abb74157.js";/* empty css               */import"./Popper-0206d46a.js";import"./lodash-f37d900b.js";import"./useMutation-267c9319.js";import"./useBaseQuery-d5b5de49.js";import"./useQuery-5e80a04e.js";import"./services-ico-9fbacd7d.js";import"./styles.module-4a1edd24.js";import"./styles.module-6aece55b.js";function $({copyId:b,handlePaste:B}){const[a,k]=x.useState(!1),g=async p=>{try{const f=await navigator.clipboard.readText(),m=JSON.parse(f);return{isCopy:!!m[p],id:m[p],params:m}}catch{return{isCopy:!1,id:"",params:{}}}},n=async(p,f)=>{try{const{isCopy:m,id:j,params:T}=await g(p);m&&f({id:j,params:T})}catch(m){console.error("Ошибка чтения буфера обмена:",m)}};return x.useEffect(()=>{(async()=>{const{isCopy:p}=await g(b);k(!p)})()},[b]),e.jsx(u,{disabled:a,onClick:()=>n(b,B),children:"Вставить"})}const oe="_wrapper_188hu_1",ae="_draggable_188hu_7",ne="_reception_188hu_21",ce="_headBlock_188hu_26",re="_blockWithPadding_188hu_27",le="_arrowBottom_188hu_36",ie="_active_188hu_43",me="_lineBlock_188hu_47",de="_itemBlock_188hu_51",pe="_toggle_188hu_56",ue="_backButton_188hu_75",o={wrapper:oe,draggable:ae,reception:ne,headBlock:ce,blockWithPadding:re,arrowBottom:le,active:ie,lineBlock:me,itemBlock:de,toggle:pe,backButton:ue};function he(b){const B=A(),{mutate:a}=X(),[k,g]=x.useState(!1),{template:n,subTemplates:p,refetchData:f,onCreateReception:m,onDeleteSubTemplate:j,onDeleteBlockTemplate:T}=b,{handleTemplates:C}=Y(),N=t=>{const s=n.bodyBlocks.find(({id:i})=>i===t);if(!s)return;const l={...s,lineBlocks:s.lineBlocks.map(({blocks:i,...y})=>({...y,blockInfo:i}))};C([l]),B(L.template.create(n.id.toString()))},D=async t=>{try{await navigator.clipboard.writeText(t),h("Copied!",{type:"info"})}catch(s){console.error("Ошибка копирования в буфер обмена:",s)}},P=async({id:t})=>{const s=p.find(i=>i.id===Number(t));if(!s)return;const l=s.bodyBlocks.map(i=>{const y={name:i.name,positionId:i.positionId,lineBlocks:i.lineBlocks.map(({id:_,blocks:v,...I})=>({...I,blockInfo:v.map(({id:O,status:R,...d})=>({...d,status:R,value:d.value??null}))})),subTemplateId:n.id};return new Promise((_,v)=>{a(y,{onSuccess:async()=>{_()},onError:I=>{h(S(I),{type:"error"}),v(I)}})})});try{await Promise.all(l),h("Copied!",{type:"success"}),f()}catch(i){console.error("Ошибка при выполнении мутаций:",i)}},E=(t,{id:s,params:l})=>{const i=p.find(d=>d.id===l.id);if(!i)throw new Error("subTemplate of undefined");const y=i.bodyBlocks.find(d=>d.id===Number(s));if(!y)throw new Error("bodyBlock of undefined");const _=n.bodyBlocks.find(d=>d.id===t);if(!_)throw new Error("targetTemplate of undefined");const v=d=>d.map(({id:be,blocks:G,...J})=>({...J,blockInfo:G.map(({id:fe,status:Q,...W})=>({...W,status:Q,value:W.value??null}))})),I=v(_.lineBlocks),O=v(y.lineBlocks),R={id:t,name:_.name,positionId:y.positionId,lineBlocks:[...I,...O],subTemplateId:n.id};a(R,{onSuccess:async()=>{h("Copied!",{type:"success"}),f()},onError:d=>{h(S(d),{type:"error"})}})},c=t=>e.jsxs(e.Fragment,{children:[e.jsx(u,{onClick:()=>{m(),t()},children:"Создать прием"}),e.jsx($,{copyId:"templateId",handlePaste:s=>{P(s),t()}}),e.jsx(u,{onClick:()=>{D(`{"templateId":${n.id}}`),t()},children:"Копировать"}),e.jsx(u,{onClick:()=>j(n.id),children:"Удалить прием"})]}),r=(t,s)=>e.jsxs(e.Fragment,{children:[e.jsx(u,{onClick:()=>{B(L.template.create(n.id.toString())),t()},children:"Создать блок"}),e.jsx(u,{onClick:()=>{D(`{"subTemplateId":${s}, "id":${n.id}}`),t()},children:"Копировать"}),e.jsx($,{copyId:"subTemplateId",handlePaste:l=>{E(s,l),t()}}),e.jsx(u,{onClick:()=>{N(s),t()},children:"Редактировать"}),e.jsx(u,{onClick:()=>s&&T(n.id,s),children:"Удалить"})]});return e.jsxs(e.Fragment,{children:[e.jsx(H,{menuItems:c,children:e.jsxs("button",{type:"button",className:w(o.draggable,o.reception),onClick:()=>g(t=>!t),children:[e.jsx("div",{className:o.headBlock,children:n.name}),e.jsx("div",{className:w(o.arrowBottom,{[o.active]:k}),children:e.jsx(F,{})})]})}),k&&e.jsxs("div",{children:[n.bodyBlocks.map(t=>e.jsxs("div",{className:w(o.draggable),children:[e.jsx("div",{className:o.headBlock,children:t.name}),e.jsx("div",{className:w(o.blockWithPadding,o.lineBlock),children:t.lineBlocks.map(s=>e.jsx("div",{className:o.itemBlock,children:s.blocks.map(l=>e.jsx("div",{children:x.createElement(Z,{...l,key:l.lineId,type:"preview",subTemplateId:t.subTemplateId,bodyBlockId:s.id,status:l.status})},l.id))},s.id))}),e.jsx(H,{menuItems:s=>r(s,t.id),children:e.jsx("div",{className:o.arrowBottom,children:e.jsx(F,{})})})]},t.id)),n.bodyBlocks.length?null:e.jsx("div",{className:o.draggable,children:e.jsx(H,{menuItems:r,children:e.jsx("div",{className:o.arrowBottom,children:e.jsx(F,{})})})})]})]})}function Ae(){const b=U(),B=A(),{data:a,isLoading:k,refetch:g}=z(b.subTemplateId),{mutate:n}=K(),{mutate:p}=M(),{mutate:f}=V(),[m,j]=x.useState(!1),[T,C]=x.useState([]),N=c=>{const r={name:`Прием №${c}`,templateId:Number(b.subTemplateId)};n(r,{onSuccess:()=>{g()},onError:t=>{h(S(t),{type:"error"})}})},D=c=>{f(c,{onSuccess:()=>{h("Success!",{type:"success"}),B(-1)},onError:r=>{h(S(r),{type:"error"})}})},P=c=>{p(c,{onSuccess:()=>{g(),h("Success!",{type:"success"})},onError:r=>{h(S(r),{type:"error"})}})},E=(c,r)=>{const t=T.map(s=>s.id===c?{...s,bodyBlocks:s.bodyBlocks.filter(l=>l.id!==r)}:s);C(t)};return x.useEffect(()=>{!k&&!(a!=null&&a.subTemplates.length)&&N(1)},[k,a]),x.useEffect(()=>{const c=(a==null?void 0:a.subTemplates.sort((r,t)=>r.id-t.id))??[];C(c)},[a]),k?null:a!=null&&a.subTemplates?e.jsxs(e.Fragment,{children:[e.jsx(ee,{}),e.jsxs("div",{className:o.wrapper,children:[e.jsx(te,{title:"",link:L.template.root,className:o.backButton}),e.jsx("div",{className:o.draggable,children:e.jsxs("div",{className:o.headBlock,children:[a.category,". ",a.name]})}),e.jsx(se,{techInfo:{info:a.techInfo}}),T.map(c=>e.jsxs("div",{children:[e.jsx(he,{template:c,subTemplates:T,refetchData:()=>g(),onCreateReception:()=>N(a.subTemplates.length+1),onDeleteSubTemplate:r=>P(r),onDeleteBlockTemplate:E}),e.jsx("div",{className:w(o.draggable,o.reception),children:e.jsx("div",{className:o.headBlock,children:"Краткое резюме посещения"})})]},c.id)),e.jsxs("div",{className:o.toggleBlock,children:[e.jsxs(q,{open:m,onClose:()=>j(!1),style:{top:-50,left:30},children:[e.jsx(u,{onClick:()=>!1,children:"Копировать"}),e.jsx(u,{onClick:()=>!1,children:"Редактировать"}),e.jsx(u,{onClick:()=>D(Number(b.subTemplateId)),children:"Удалить"})]}),e.jsx("button",{type:"button",onClick:()=>j(!0),className:w(o.toggle,{[o.active]:m}),children:"+"})]})]})]}):(B(-1),null)}export{Ae as default};

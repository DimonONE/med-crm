import{r as T,j as e,M as g,a as q,u as z,P as W,c as w,f as V,Q as l,g as J}from"./index-f3fd4875.js";import"./styles.module-60436982.js";import{u as X,a as Y,b as Z,c as ee,d as te,e as se,f as oe,g as ae,C as ne}from"./appointmentTableApi-99238205.js";import{e as j}from"./utils-045dd2ef.js";import"./styles.module-eea2a584.js";import{H as ce}from"./HeaderTemplate-c59a8d3b.js";import{S as L}from"./arrow-bottom-filter-3a5f1bc8.js";import{B as re}from"./BackButton-00ebe5a5.js";import{D as O}from"./CardsNavigate-0d0882af.js";import{T as le}from"./TechInfo-a8da95c6.js";import"./Checkbox-ca597904.js";import"./Typography-cf2be92b.js";import"./extendSxProp-6285f959.js";import"./Modal-4f6b9d89.js";import"./DatePicker-1844a6a5.js";/* empty css               */import"./Popper-7c78b30a.js";import"./lodash-81e24afa.js";import"./useMutation-131cfbe0.js";import"./useBaseQuery-588bdd2f.js";import"./useQuery-e978b944.js";import"./services-ico-c9ffa9f5.js";import"./styles.module-4a1edd24.js";import"./styles.module-6aece55b.js";import"./close-gray-ico-0519171e.js";function Q({copyId:h,handlePaste:x}){const[o,f]=T.useState(!1),b=async u=>{try{const n=await navigator.clipboard.readText(),i=JSON.parse(n);return{isCopy:!!i[u],id:i[u],params:i}}catch{return{isCopy:!1,id:"",params:{}}}},I=async(u,n)=>{try{const{isCopy:i,id:B,params:_}=await b(u);i&&n({id:B,params:_})}catch(i){console.error("Ошибка чтения буфера обмена:",i)}};return T.useEffect(()=>{(async()=>{const{isCopy:u}=await b(h);f(!u)})()},[h]),e.jsx(g,{disabled:o,onClick:()=>I(h,x),children:"Вставить"})}const ie="_wrapper_188hu_1",me="_draggable_188hu_7",de="_reception_188hu_21",pe="_headBlock_188hu_26",ue="_blockWithPadding_188hu_27",he="_arrowBottom_188hu_36",be="_active_188hu_43",ge="_lineBlock_188hu_47",fe="_itemBlock_188hu_51",ke="_toggle_188hu_56",Te="_backButton_188hu_75",a={wrapper:ie,draggable:me,reception:de,headBlock:pe,blockWithPadding:ue,arrowBottom:he,active:be,lineBlock:ge,itemBlock:fe,toggle:ke,backButton:Te};function xe(h){const x=q(),o=z(),{mutate:f}=se(),{mutate:b}=oe(),[I,u]=T.useState(!1),{template:n,refetchData:i,onCreateReception:B,onDeleteSubTemplate:_}=h,{handleTemplates:E}=ae(),F=t=>{const s=n.bodyBlocks.find(({id:k})=>k===t);if(!s)return;const d={...s,lineBlocks:s.lineBlocks.map(({blocks:k,...v})=>({...v,blockInfo:k}))};E([d]),o(W.template.create(x.subTemplateId,n.id.toString()))},N=async t=>{try{await navigator.clipboard.writeText(t),l("Copied!",{type:"info"})}catch(s){console.error("Ошибка копирования в буфер обмена:",s)}},A=async({id:t,params:s})=>{const k=(await J({url:`/template/get-one/${s.coreTemplateId}`,method:"GET"})).data.subTemplates.find(m=>m.id===Number(t));if(!k)return;const v=k.bodyBlocks.sort((m,y)=>m.id-y.id).map((m,y)=>{const D={name:m.name,positionId:m.positionId,lineBlocks:m.lineBlocks.map(({id:P,blocks:C,...S})=>({...S,blockInfo:C.map(({id:p,status:$,...R})=>({...R,status:$,value:R.value??null}))})),subTemplateId:n.id};return new Promise((P,C)=>{f(D,{onSuccess:async()=>{P(),k.bodyBlocks.length===y+1&&(l("Copied!",{type:"success"}),i())},onError:S=>{l(j(S),{type:"error"}),C(S)}})})});try{await Promise.all(v)}catch(m){console.error("Ошибка при выполнении мутаций:",m)}},G=async(t,{id:s,params:d})=>{const v=(await J({url:`/template/get-one/${d.coreTemplateId}`,method:"GET"})).data.subTemplates.find(p=>p.id===d.id);if(!v)throw new Error("subTemplate of undefined");const m=v.bodyBlocks.find(p=>p.id===Number(s));if(!m)throw new Error("bodyBlock of undefined");const y=n.bodyBlocks.find(p=>p.id===t);if(!y)throw new Error("targetTemplate of undefined");const D=p=>p.map(({id:$,blocks:R,...K})=>({...K,blockInfo:R.map(({id:Be,status:M,...U})=>({...U,status:M,value:U.value??null}))})),P=D(y.lineBlocks),C=D(m.lineBlocks),S={id:t,name:y.name,positionId:m.positionId,lineBlocks:[...P,...C].sort((p,$)=>p.positionId-$.positionId),subTemplateId:n.id};f(S,{onSuccess:async()=>{l("Copied!",{type:"success"}),i()},onError:p=>{l(j(p),{type:"error"})}})},H=async t=>{b(t,{onSuccess:async()=>{l("Deleted!",{type:"success"}),i()},onError:s=>{l(j(s),{type:"error"})}})},c=t=>e.jsxs(e.Fragment,{children:[e.jsx(g,{onClick:()=>{B(),t()},children:"Создать прием"}),e.jsx(Q,{copyId:"templateId",handlePaste:s=>{A(s),t()}}),e.jsx(g,{onClick:()=>{N(`{"templateId":${n.id}, "coreTemplateId":${n.templateId}}`),t()},children:"Копировать"}),e.jsx(g,{onClick:()=>_(n.id),children:"Удалить прием"})]}),r=(t,s)=>e.jsxs(e.Fragment,{children:[e.jsx(g,{onClick:()=>{o(W.template.create(x.subTemplateId,n.id.toString())),t()},children:"Создать блок"}),e.jsx(g,{onClick:()=>{N(`{"subTemplateId":${s}, "id":${n.id}, "coreTemplateId":${n.templateId}}`),t()},children:"Копировать"}),e.jsx(Q,{copyId:"subTemplateId",handlePaste:d=>{G(s,d),t()}}),e.jsx(g,{onClick:()=>{F(s),t()},children:"Редактировать"}),e.jsx(g,{onClick:()=>s&&H(s),children:"Удалить"})]});return e.jsxs(e.Fragment,{children:[e.jsx(O,{menuItems:c,children:e.jsxs("button",{type:"button",className:w(a.draggable,a.reception),onClick:()=>u(t=>!t),children:[e.jsx("div",{className:a.headBlock,style:{textAlign:"left"},children:n.name}),e.jsx("div",{className:w(a.arrowBottom,{[a.active]:I}),children:e.jsx(L,{})})]})}),I&&e.jsxs("div",{children:[n.bodyBlocks.sort((t,s)=>t.id-s.id).map(t=>e.jsxs("div",{className:w(a.draggable),children:[e.jsxs("div",{className:a.headBlock,children:[t.name," "]}),e.jsx("div",{className:w(a.blockWithPadding,a.lineBlock),children:t.lineBlocks.map(s=>e.jsx("div",{className:a.itemBlock,children:s.blocks.map(d=>e.jsx("div",{children:T.createElement(ne,{...d,key:d.lineId,type:"preview",subTemplateId:t.subTemplateId,bodyBlockId:s.id,status:d.status})},d.id))},s.id))}),e.jsx(O,{menuItems:s=>r(s,t.id),children:e.jsx("div",{className:a.arrowBottom,children:e.jsx(L,{})})})]},t.id)),n.bodyBlocks.length?null:e.jsx("div",{className:a.draggable,children:e.jsx(O,{menuItems:r,children:e.jsx("div",{className:a.arrowBottom,children:e.jsx(L,{})})})})]})]})}function ze(){const h=q(),x=z(),{data:o,isLoading:f,refetch:b}=X(h.subTemplateId),{mutate:I}=Y(),{mutate:u}=Z(),{mutate:n}=ee(),{mutate:i}=te(),[B,_]=T.useState(!1),[E,F]=T.useState([]),N=c=>{const r={name:`Прием №${c}`,templateId:Number(h.subTemplateId)};I(r,{onSuccess:()=>{b()},onError:t=>{l(j(t),{type:"error"})}})},A=c=>{i(c,{onSuccess:()=>{l("Success!",{type:"success"}),x(-1)},onError:r=>{l(j(r),{type:"error"})}})},G=c=>{n(c,{onSuccess:()=>{b(),l("Success!",{type:"success"})},onError:r=>{l(j(r),{type:"error"})}})},H=c=>{o&&u({id:o.id,category:o.category,name:o.name,techInfo:c},{onSuccess:()=>{b(),l("Success!",{type:"success"})},onError:r=>{l(j(r),{type:"error"})}})};return T.useEffect(()=>{!f&&!(o!=null&&o.subTemplates.length)&&N(1)},[f,o]),T.useEffect(()=>{const c=(o==null?void 0:o.subTemplates.sort((r,t)=>r.id-t.id))??[];F(c)},[o]),f?null:o!=null&&o.subTemplates?e.jsxs(e.Fragment,{children:[e.jsx(ce,{}),e.jsxs("div",{className:a.wrapper,children:[e.jsx(re,{title:"",link:W.template.root,className:a.backButton}),e.jsx("div",{className:a.draggable,children:e.jsxs("div",{className:a.headBlock,children:[o.category,". ",o.name]})}),e.jsx(le,{techInfo:{info:o.techInfo},isEditing:!0,onSaveInfo:H}),E.map(c=>e.jsxs("div",{children:[e.jsx(xe,{template:c,subTemplates:E,refetchData:()=>b(),onCreateReception:()=>N(o.subTemplates.length+1),onDeleteSubTemplate:r=>G(r)}),e.jsx("div",{className:w(a.draggable,a.reception),children:e.jsx("div",{className:a.headBlock,children:"Краткое резюме посещения"})})]},c.id)),e.jsxs("div",{className:a.toggleBlock,children:[e.jsx(V,{open:B,onClose:()=>_(!1),style:{top:-50,left:30},children:e.jsx(g,{onClick:()=>A(Number(h.subTemplateId)),children:"Удалить"})}),e.jsx("button",{type:"button",onClick:()=>_(!0),className:w(a.toggle,{[a.active]:B}),children:"+"})]})]})]}):(x(-1),null)}export{ze as default};

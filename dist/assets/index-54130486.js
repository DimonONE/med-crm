import{r as g,j as e,M as f,a as q,u as G,P as H,c as I,f as z,Q as d}from"./index-3da5cc6b.js";import"./styles.module-60436982.js";import{u as K,a as M,b as V,c as X,d as Y,e as Z,f as ee,C as te}from"./appointmentTableApi-382d3cf8.js";import{e as S}from"./utils-045dd2ef.js";import"./styles.module-eea2a584.js";import{H as se}from"./HeaderTemplate-203e8905.js";import{S as F}from"./arrow-bottom-filter-b1be4ce4.js";import{B as oe}from"./BackButton-18f7784f.js";import{D as A}from"./CardsNavigate-3a1062af.js";import{T as ae}from"./TechInfo-fb823256.js";import"./Checkbox-d96d046f.js";import"./Typography-a1c13a6d.js";import"./extendSxProp-e65c1ed2.js";import"./Modal-7f660902.js";import"./DatePicker-635a1657.js";/* empty css               */import"./Popper-73117552.js";import"./lodash-38bb2507.js";import"./useMutation-39d089a9.js";import"./useBaseQuery-7fd443c2.js";import"./useQuery-280492f8.js";import"./services-ico-f14428e8.js";import"./styles.module-4a1edd24.js";import"./styles.module-6aece55b.js";function $({copyId:u,handlePaste:k}){const[n,x]=g.useState(!1),h=async a=>{try{const b=await navigator.clipboard.readText(),c=JSON.parse(b);return{isCopy:!!c[a],id:c[a],params:c}}catch{return{isCopy:!1,id:"",params:{}}}},w=async(a,b)=>{try{const{isCopy:c,id:B,params:y}=await h(a);c&&b({id:B,params:y})}catch(c){console.error("Ошибка чтения буфера обмена:",c)}};return g.useEffect(()=>{(async()=>{const{isCopy:a}=await h(u);x(!a)})()},[u]),e.jsx(f,{disabled:n,onClick:()=>w(u,k),children:"Вставить"})}const ne="_wrapper_188hu_1",ce="_draggable_188hu_7",re="_reception_188hu_21",le="_headBlock_188hu_26",ie="_blockWithPadding_188hu_27",me="_arrowBottom_188hu_36",de="_active_188hu_43",pe="_lineBlock_188hu_47",ue="_itemBlock_188hu_51",he="_toggle_188hu_56",be="_backButton_188hu_75",o={wrapper:ne,draggable:ce,reception:re,headBlock:le,blockWithPadding:ie,arrowBottom:me,active:de,lineBlock:pe,itemBlock:ue,toggle:he,backButton:be};function fe(u){const k=G(),{mutate:n}=Y(),{mutate:x}=Z(),[h,w]=g.useState(!1),{template:a,subTemplates:b,refetchData:c,onCreateReception:B,onDeleteSubTemplate:y}=u,{handleTemplates:P}=ee(),C=t=>{const s=a.bodyBlocks.find(({id:r})=>r===t);if(!s)return;const i={...s,lineBlocks:s.lineBlocks.map(({blocks:r,...j})=>({...j,blockInfo:r}))};P([i]),k(H.template.create(a.id.toString()))},D=async t=>{try{await navigator.clipboard.writeText(t),d("Copied!",{type:"info"})}catch(s){console.error("Ошибка копирования в буфер обмена:",s)}},E=async({id:t})=>{const s=b.find(r=>r.id===Number(t));if(!s)return;const i=s.bodyBlocks.map(r=>{const j={name:r.name,positionId:r.positionId,lineBlocks:r.lineBlocks.map(({id:T,blocks:_,...v})=>({...v,blockInfo:_.map(({id:O,status:R,...m})=>({...m,status:R,value:m.value??null}))})),subTemplateId:a.id};return new Promise((T,_)=>{n(j,{onSuccess:async()=>{T()},onError:v=>{d(S(v),{type:"error"}),_(v)}})})});try{await Promise.all(i),d("Copied!",{type:"success"}),c()}catch(r){console.error("Ошибка при выполнении мутаций:",r)}},l=(t,{id:s,params:i})=>{const r=b.find(m=>m.id===i.id);if(!r)throw new Error("subTemplate of undefined");const j=r.bodyBlocks.find(m=>m.id===Number(s));if(!j)throw new Error("bodyBlock of undefined");const T=a.bodyBlocks.find(m=>m.id===t);if(!T)throw new Error("targetTemplate of undefined");const _=m=>m.map(({id:ge,blocks:J,...Q})=>({...Q,blockInfo:J.map(({id:ke,status:U,...W})=>({...W,status:U,value:W.value??null}))})),v=_(T.lineBlocks),O=_(j.lineBlocks),R={id:t,name:T.name,positionId:j.positionId,lineBlocks:[...v,...O],subTemplateId:a.id};n(R,{onSuccess:async()=>{d("Copied!",{type:"success"}),c()},onError:m=>{d(S(m),{type:"error"})}})},p=async t=>{x(t,{onSuccess:async()=>{d("Deleted!",{type:"success"}),c()},onError:s=>{d(S(s),{type:"error"})}})},N=t=>e.jsxs(e.Fragment,{children:[e.jsx(f,{onClick:()=>{B(),t()},children:"Создать прием"}),e.jsx($,{copyId:"templateId",handlePaste:s=>{E(s),t()}}),e.jsx(f,{onClick:()=>{D(`{"templateId":${a.id}}`),t()},children:"Копировать"}),e.jsx(f,{onClick:()=>y(a.id),children:"Удалить прием"})]}),L=(t,s)=>e.jsxs(e.Fragment,{children:[e.jsx(f,{onClick:()=>{k(H.template.create(a.id.toString())),t()},children:"Создать блок"}),e.jsx(f,{onClick:()=>{D(`{"subTemplateId":${s}, "id":${a.id}}`),t()},children:"Копировать"}),e.jsx($,{copyId:"subTemplateId",handlePaste:i=>{l(s,i),t()}}),e.jsx(f,{onClick:()=>{C(s),t()},children:"Редактировать"}),e.jsx(f,{onClick:()=>s&&p(s),children:"Удалить"})]});return e.jsxs(e.Fragment,{children:[e.jsx(A,{menuItems:N,children:e.jsxs("button",{type:"button",className:I(o.draggable,o.reception),onClick:()=>w(t=>!t),children:[e.jsx("div",{className:o.headBlock,style:{textAlign:"left"},children:a.name}),e.jsx("div",{className:I(o.arrowBottom,{[o.active]:h}),children:e.jsx(F,{})})]})}),h&&e.jsxs("div",{children:[a.bodyBlocks.map(t=>e.jsxs("div",{className:I(o.draggable),children:[e.jsx("div",{className:o.headBlock,children:t.name}),e.jsx("div",{className:I(o.blockWithPadding,o.lineBlock),children:t.lineBlocks.map(s=>e.jsx("div",{className:o.itemBlock,children:s.blocks.map(i=>e.jsx("div",{children:g.createElement(te,{...i,key:i.lineId,type:"preview",subTemplateId:t.subTemplateId,bodyBlockId:s.id,status:i.status})},i.id))},s.id))}),e.jsx(A,{menuItems:s=>L(s,t.id),children:e.jsx("div",{className:o.arrowBottom,children:e.jsx(F,{})})})]},t.id)),a.bodyBlocks.length?null:e.jsx("div",{className:o.draggable,children:e.jsx(A,{menuItems:L,children:e.jsx("div",{className:o.arrowBottom,children:e.jsx(F,{})})})})]})]})}function Je(){const u=q(),k=G(),{data:n,isLoading:x,refetch:h}=K(u.subTemplateId),{mutate:w}=M(),{mutate:a}=V(),{mutate:b}=X(),[c,B]=g.useState(!1),[y,P]=g.useState([]),C=l=>{const p={name:`Прием №${l}`,templateId:Number(u.subTemplateId)};w(p,{onSuccess:()=>{h()},onError:N=>{d(S(N),{type:"error"})}})},D=l=>{b(l,{onSuccess:()=>{d("Success!",{type:"success"}),k(-1)},onError:p=>{d(S(p),{type:"error"})}})},E=l=>{a(l,{onSuccess:()=>{h(),d("Success!",{type:"success"})},onError:p=>{d(S(p),{type:"error"})}})};return g.useEffect(()=>{!x&&!(n!=null&&n.subTemplates.length)&&C(1)},[x,n]),g.useEffect(()=>{const l=(n==null?void 0:n.subTemplates.sort((p,N)=>p.id-N.id))??[];P(l)},[n]),x?null:n!=null&&n.subTemplates?e.jsxs(e.Fragment,{children:[e.jsx(se,{}),e.jsxs("div",{className:o.wrapper,children:[e.jsx(oe,{title:"",link:H.template.root,className:o.backButton}),e.jsx("div",{className:o.draggable,children:e.jsxs("div",{className:o.headBlock,children:[n.category,". ",n.name]})}),e.jsx(ae,{techInfo:{info:n.techInfo}}),y.map(l=>e.jsxs("div",{children:[e.jsx(fe,{template:l,subTemplates:y,refetchData:()=>h(),onCreateReception:()=>C(n.subTemplates.length+1),onDeleteSubTemplate:p=>E(p)}),e.jsx("div",{className:I(o.draggable,o.reception),children:e.jsx("div",{className:o.headBlock,children:"Краткое резюме посещения"})})]},l.id)),e.jsxs("div",{className:o.toggleBlock,children:[e.jsx(z,{open:c,onClose:()=>B(!1),style:{top:-50,left:30},children:e.jsx(f,{onClick:()=>D(Number(u.subTemplateId)),children:"Удалить"})}),e.jsx("button",{type:"button",onClick:()=>B(!0),className:I(o.toggle,{[o.active]:c}),children:"+"})]})]})]}):(k(-1),null)}export{Je as default};

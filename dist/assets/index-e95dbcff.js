import{r as x,j as e,M as f,a as G,u as J,P as H,c as S,f as K,Q as d}from"./index-62e94d26.js";import"./styles.module-60436982.js";import{u as M,a as V,b as X,c as Y,d as Z,e as ee,f as te,C as se}from"./appointmentTableApi-f4e9c048.js";import{e as w}from"./utils-045dd2ef.js";import"./styles.module-eea2a584.js";import{H as oe}from"./HeaderTemplate-5e5c98d2.js";import{S as F}from"./arrow-bottom-filter-b8ee8b2d.js";import{B as ae}from"./BackButton-73eed7b1.js";import{D as A}from"./CardsNavigate-7228228a.js";import{T as ne}from"./TechInfo-69e486c1.js";import"./Checkbox-1ca151ff.js";import"./Typography-b4cb904a.js";import"./extendSxProp-f5182726.js";import"./Modal-fb292642.js";import"./DatePicker-67d98e6b.js";/* empty css               */import"./Popper-0b990638.js";import"./lodash-60d9989b.js";import"./useMutation-7ffdae08.js";import"./useBaseQuery-a2a36ab9.js";import"./useQuery-ef9f8b4d.js";import"./services-ico-88983de3.js";import"./styles.module-4a1edd24.js";import"./styles.module-6aece55b.js";function $({copyId:h,handlePaste:B}){const[a,g]=x.useState(!1),k=async u=>{try{const n=await navigator.clipboard.readText(),r=JSON.parse(n);return{isCopy:!!r[u],id:r[u],params:r}}catch{return{isCopy:!1,id:"",params:{}}}},T=async(u,n)=>{try{const{isCopy:r,id:b,params:y}=await k(u);r&&n({id:b,params:y})}catch(r){console.error("Ошибка чтения буфера обмена:",r)}};return x.useEffect(()=>{(async()=>{const{isCopy:u}=await k(h);g(!u)})()},[h]),e.jsx(f,{disabled:a,onClick:()=>T(h,B),children:"Вставить"})}const ce="_wrapper_188hu_1",re="_draggable_188hu_7",le="_reception_188hu_21",ie="_headBlock_188hu_26",me="_blockWithPadding_188hu_27",de="_arrowBottom_188hu_36",pe="_active_188hu_43",ue="_lineBlock_188hu_47",he="_itemBlock_188hu_51",be="_toggle_188hu_56",fe="_backButton_188hu_75",o={wrapper:ce,draggable:re,reception:le,headBlock:ie,blockWithPadding:me,arrowBottom:de,active:pe,lineBlock:ue,itemBlock:he,toggle:be,backButton:fe};function ge(h){const B=G(),a=J(),{mutate:g}=Z(),{mutate:k}=ee(),[T,u]=x.useState(!1),{template:n,subTemplates:r,refetchData:b,onCreateReception:y,onDeleteSubTemplate:P}=h,{handleTemplates:C}=te(),E=t=>{const s=n.bodyBlocks.find(({id:c})=>c===t);if(!s)return;const i={...s,lineBlocks:s.lineBlocks.map(({blocks:c,...j})=>({...j,blockInfo:c}))};C([i]),a(H.template.create(B.subTemplateId,n.id.toString()))},D=async t=>{try{await navigator.clipboard.writeText(t),d("Copied!",{type:"info"})}catch(s){console.error("Ошибка копирования в буфер обмена:",s)}},l=async({id:t})=>{const s=r.find(c=>c.id===Number(t));if(!s)return;const i=s.bodyBlocks.map(c=>{const j={name:c.name,positionId:c.positionId,lineBlocks:c.lineBlocks.map(({id:_,blocks:v,...I})=>({...I,blockInfo:v.map(({id:O,status:R,...m})=>({...m,status:R,value:m.value??null}))})),subTemplateId:n.id};return new Promise((_,v)=>{g(j,{onSuccess:async()=>{_()},onError:I=>{d(w(I),{type:"error"}),v(I)}})})});try{await Promise.all(i),d("Copied!",{type:"success"}),b()}catch(c){console.error("Ошибка при выполнении мутаций:",c)}},p=(t,{id:s,params:i})=>{const c=r.find(m=>m.id===i.id);if(!c)throw new Error("subTemplate of undefined");const j=c.bodyBlocks.find(m=>m.id===Number(s));if(!j)throw new Error("bodyBlock of undefined");const _=n.bodyBlocks.find(m=>m.id===t);if(!_)throw new Error("targetTemplate of undefined");const v=m=>m.map(({id:ke,blocks:U,...q})=>({...q,blockInfo:U.map(({id:xe,status:z,...W})=>({...W,status:z,value:W.value??null}))})),I=v(_.lineBlocks),O=v(j.lineBlocks),R={id:t,name:_.name,positionId:j.positionId,lineBlocks:[...I,...O],subTemplateId:n.id};g(R,{onSuccess:async()=>{d("Copied!",{type:"success"}),b()},onError:m=>{d(w(m),{type:"error"})}})},N=async t=>{k(t,{onSuccess:async()=>{d("Deleted!",{type:"success"}),b()},onError:s=>{d(w(s),{type:"error"})}})},Q=t=>e.jsxs(e.Fragment,{children:[e.jsx(f,{onClick:()=>{y(),t()},children:"Создать прием"}),e.jsx($,{copyId:"templateId",handlePaste:s=>{l(s),t()}}),e.jsx(f,{onClick:()=>{D(`{"templateId":${n.id}}`),t()},children:"Копировать"}),e.jsx(f,{onClick:()=>P(n.id),children:"Удалить прием"})]}),L=(t,s)=>e.jsxs(e.Fragment,{children:[e.jsx(f,{onClick:()=>{a(H.template.create(B.subTemplateId,n.id.toString())),t()},children:"Создать блок"}),e.jsx(f,{onClick:()=>{D(`{"subTemplateId":${s}, "id":${n.id}}`),t()},children:"Копировать"}),e.jsx($,{copyId:"subTemplateId",handlePaste:i=>{p(s,i),t()}}),e.jsx(f,{onClick:()=>{E(s),t()},children:"Редактировать"}),e.jsx(f,{onClick:()=>s&&N(s),children:"Удалить"})]});return e.jsxs(e.Fragment,{children:[e.jsx(A,{menuItems:Q,children:e.jsxs("button",{type:"button",className:S(o.draggable,o.reception),onClick:()=>u(t=>!t),children:[e.jsx("div",{className:o.headBlock,style:{textAlign:"left"},children:n.name}),e.jsx("div",{className:S(o.arrowBottom,{[o.active]:T}),children:e.jsx(F,{})})]})}),T&&e.jsxs("div",{children:[n.bodyBlocks.sort((t,s)=>t.id-s.id).map(t=>e.jsxs("div",{className:S(o.draggable),children:[e.jsxs("div",{className:o.headBlock,children:[t.name," "]}),e.jsx("div",{className:S(o.blockWithPadding,o.lineBlock),children:t.lineBlocks.map(s=>e.jsx("div",{className:o.itemBlock,children:s.blocks.map(i=>e.jsx("div",{children:x.createElement(se,{...i,key:i.lineId,type:"preview",subTemplateId:t.subTemplateId,bodyBlockId:s.id,status:i.status})},i.id))},s.id))}),e.jsx(A,{menuItems:s=>L(s,t.id),children:e.jsx("div",{className:o.arrowBottom,children:e.jsx(F,{})})})]},t.id)),n.bodyBlocks.length?null:e.jsx("div",{className:o.draggable,children:e.jsx(A,{menuItems:L,children:e.jsx("div",{className:o.arrowBottom,children:e.jsx(F,{})})})})]})]})}function Qe(){const h=G(),B=J(),{data:a,isLoading:g,refetch:k}=M(h.subTemplateId),{mutate:T}=V(),{mutate:u}=X(),{mutate:n}=Y(),[r,b]=x.useState(!1),[y,P]=x.useState([]),C=l=>{const p={name:`Прием №${l}`,templateId:Number(h.subTemplateId)};T(p,{onSuccess:()=>{k()},onError:N=>{d(w(N),{type:"error"})}})},E=l=>{n(l,{onSuccess:()=>{d("Success!",{type:"success"}),B(-1)},onError:p=>{d(w(p),{type:"error"})}})},D=l=>{u(l,{onSuccess:()=>{k(),d("Success!",{type:"success"})},onError:p=>{d(w(p),{type:"error"})}})};return x.useEffect(()=>{!g&&!(a!=null&&a.subTemplates.length)&&C(1)},[g,a]),x.useEffect(()=>{const l=(a==null?void 0:a.subTemplates.sort((p,N)=>p.id-N.id))??[];P(l)},[a]),g?null:a!=null&&a.subTemplates?e.jsxs(e.Fragment,{children:[e.jsx(oe,{}),e.jsxs("div",{className:o.wrapper,children:[e.jsx(ae,{title:"",link:H.template.root,className:o.backButton}),e.jsx("div",{className:o.draggable,children:e.jsxs("div",{className:o.headBlock,children:[a.category,". ",a.name]})}),e.jsx(ne,{techInfo:{info:a.techInfo}}),y.map(l=>e.jsxs("div",{children:[e.jsx(ge,{template:l,subTemplates:y,refetchData:()=>k(),onCreateReception:()=>C(a.subTemplates.length+1),onDeleteSubTemplate:p=>D(p)}),e.jsx("div",{className:S(o.draggable,o.reception),children:e.jsx("div",{className:o.headBlock,children:"Краткое резюме посещения"})})]},l.id)),e.jsxs("div",{className:o.toggleBlock,children:[e.jsx(K,{open:r,onClose:()=>b(!1),style:{top:-50,left:30},children:e.jsx(f,{onClick:()=>E(Number(h.subTemplateId)),children:"Удалить"})}),e.jsx("button",{type:"button",onClick:()=>b(!0),className:S(o.toggle,{[o.active]:r}),children:"+"})]})]})]}):(B(-1),null)}export{Qe as default};
